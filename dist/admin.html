<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sahay Admin - Prudence Hospitals</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">

    <div id="app" class="container mx-auto p-4 md:p-8">
        <div class="bg-white p-8 rounded-3xl shadow-xl border border-slate-200">
            <!-- Header Section -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                <div>
                    <h1 class="text-3xl font-extrabold text-slate-900 tracking-tight">Sahay Admin Dashboard</h1>
                    <p class="text-slate-500 mt-1">Real-time monitoring of AI-booked appointments for Prudence Hospitals.</p>
                </div>
                <div class="bg-blue-600 text-white px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2">
                    <span class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></span> LIVE UPDATES ENABLED
                </div>
            </div>
            
            <!-- Requirement: Real-time KPI Dashboard -->
            <div id="kpi-cards" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-blue-50 p-6 rounded-2xl border border-blue-100 transition hover:shadow-md">
                    <p class="text-xs text-blue-600 font-bold uppercase tracking-wider mb-1">Total Appointments</p>
                    <p id="kpi-total" class="text-4xl font-black text-blue-900">0</p>
                </div>
                <div class="bg-emerald-50 p-6 rounded-2xl border border-emerald-100 transition hover:shadow-md">
                    <p class="text-xs text-emerald-600 font-bold uppercase tracking-wider mb-1">Confirmed</p>
                    <p id="kpi-confirmed" class="text-4xl font-black text-emerald-900">0</p>
                </div>
                <div class="bg-rose-50 p-6 rounded-2xl border border-rose-100 transition hover:shadow-md">
                    <p class="text-xs text-rose-600 font-bold uppercase tracking-wider mb-1">Cancelled</p>
                    <p id="kpi-cancelled" class="text-4xl font-black text-rose-900">0</p>
                </div>
            </div>

            <!-- Requirement: Filtering System -->
            <div id="filter-container" class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8 p-6 bg-slate-50 rounded-2xl border border-slate-100">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Filter by Date</label>
                    <input type="date" id="date-filter" class="w-full p-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition shadow-sm">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Specialty</label>
                    <select id="specialty-filter" class="w-full p-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition shadow-sm">
                        <option value="">All Departments</option>
                    </select>
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Status</label>
                    <select id="status-filter" class="w-full p-3 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none transition shadow-sm">
                        <option value="">All Statuses</option>
                        <option value="confirmed">Confirmed</option>
                        <option value="cancelled">Cancelled</option>
                    </select>
                </div>
                <div class="flex items-end">
                    <button id="clear-filters-btn" class="w-full bg-slate-200 text-slate-700 font-bold px-4 py-3 rounded-xl hover:bg-slate-300 transition shadow-sm">
                        <i class="fas fa-undo mr-2"></i> Reset Filters
                    </button>
                </div>
            </div>

            <!-- Loading & Error States -->
            <div id="loading" class="text-center p-12"><div class="animate-spin text-blue-600 mb-4"><i class="fas fa-circle-notch fa-3x"></i></div><p class="text-slate-500 font-medium">Fetching clinical data...</p></div>
            <div id="error" class="hidden bg-rose-50 border border-rose-200 text-rose-700 px-6 py-4 rounded-2xl mb-6"><strong class="font-bold">Error:</strong> <span id="error-message"></span></div>
            
            <!-- Requirement: Data Grid Implementation -->
            <div id="table-container" class="hidden overflow-x-auto rounded-2xl border border-slate-100 shadow-inner bg-slate-50">
                <table class="min-w-full divide-y divide-slate-200">
                    <thead class="bg-slate-100">
                        <tr>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-widest">Patient Details</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-widest">Doctor / Dept</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-widest">Schedule</th>
                            <th class="px-6 py-4 text-left text-xs font-bold text-slate-500 uppercase tracking-widest">Status</th>
                        </tr>
                    </thead>
                    <tbody id="appointments-tbody" class="bg-white divide-y divide-slate-100 text-slate-700">
                        <!-- Rows injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let supabaseClient;
        const loadingDiv = document.getElementById('loading');
        const errorDiv = document.getElementById('error');
        const errorMessageSpan = document.getElementById('error-message');
        const tableContainer = document.getElementById('table-container');
        const tbody = document.getElementById('appointments-tbody');
        const dateFilter = document.getElementById('date-filter');
        const specialtyFilter = document.getElementById('specialty-filter');
        const statusFilter = document.getElementById('status-filter');
        const clearFiltersBtn = document.getElementById('clear-filters-btn');
        const kpiTotal = document.getElementById('kpi-total');
        const kpiConfirmed = document.getElementById('kpi-confirmed');
        const kpiCancelled = document.getElementById('kpi-cancelled');
        
        let allAppointments = []; 
        const getTodayDateString = () => new Date().toLocaleDateString('en-CA');

        // Requirement: Status Badge color-coding
        function renderTable(data) {
            tbody.innerHTML = '';
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center py-12 text-slate-400 font-medium italic">No appointments found.</td></tr>';
            } else {
                data.forEach(appt => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-slate-50 transition';
                    const formattedDate = new Date(appt.appointment_date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    const formattedTime = appt.appointment_time.substring(0, 5);
                    const isConfirmed = appt.status === 'confirmed';
                    const statusClass = isConfirmed ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700';

                    row.innerHTML = `
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-900">${appt.patient_name}</div>
                            <div class="text-xs text-slate-400 font-medium">${appt.phone || 'No phone'}</div>
                        </td>
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-700">Dr. ${appt.doctors?.name || 'Unknown'}</div>
                            <div class="text-xs font-bold text-blue-500 uppercase tracking-tighter">${appt.doctors?.specialty || 'General'}</div>
                        </td>
                        <td class="px-6 py-4 text-sm">
                            <div class="font-bold text-slate-600">${formattedDate}</div>
                            <div class="text-slate-400">${formattedTime} hrs</div>
                        </td>
                        <td class="px-6 py-4">
                            <span class="px-3 py-1 text-[10px] font-black uppercase tracking-widest rounded-full ${statusClass}">
                                ${isConfirmed ? '● Confirmed' : '● Cancelled'}
                            </span>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }
        }
        
        function updateKpis(data) {
            kpiTotal.textContent = data.length;
            kpiConfirmed.textContent = data.filter(a => a.status === 'confirmed').length;
            kpiCancelled.textContent = data.filter(a => a.status === 'cancelled').length;
        }

        function applyFilters() {
            const specialty = specialtyFilter.value;
            const status = statusFilter.value;
            let filtered = [...allAppointments];
            if (specialty) filtered = filtered.filter(a => a.doctors?.specialty === specialty);
            if (status) filtered = filtered.filter(a => a.status === status);
            renderTable(filtered);
        }

        async function fetchData(dateString) {
            // Only show the full-page loader if no data is currently visible
            if (allAppointments.length === 0) {
                loadingDiv.classList.remove('hidden');
                tableContainer.classList.add('hidden');
            }
            errorDiv.classList.add('hidden');
            try {
                const { data, error } = await supabaseClient
                    .from('appointments')
                    .select(`patient_name, phone, appointment_date, appointment_time, status, doctors ( name, specialty )`)
                    .eq('appointment_date', dateString)
                    .order('appointment_time', { ascending: true });
                if (error) throw error;
                allAppointments = data;
                updateKpis(data);
                applyFilters();
                loadingDiv.classList.add('hidden');
                tableContainer.classList.remove('hidden');
            } catch(err) {
                errorMessageSpan.textContent = err.message;
                loadingDiv.classList.add('hidden');
                errorDiv.classList.remove('hidden');
            }
        }

        // Real-time Update Listener
        function setupRealtime() {
            supabaseClient
                .channel('schema-db-changes')
                .on(
                    'postgres_changes',
                    {
                        event: '*',
                        schema: 'public',
                        table: 'appointments'
                    },
                    (payload) => {
                        console.log('Database Change Detected:', payload);
                        // Silently refresh the current date view
                        fetchData(dateFilter.value);
                    }
                )
                .subscribe();
        }
        
        async function populateSpecialties() {
            const { data, error } = await supabaseClient.from('doctors').select('specialty');
            if (!error) {
                const unique = [...new Set(data.map(d => d.specialty))].sort();
                unique.forEach(s => {
                    const opt = document.createElement('option');
                    opt.value = s; opt.textContent = s;
                    specialtyFilter.appendChild(opt);
                });
            }
        }
        
        function initDashboard() {
            dateFilter.addEventListener('change', () => fetchData(dateFilter.value));
            specialtyFilter.addEventListener('change', applyFilters);
            statusFilter.addEventListener('change', applyFilters);
            clearFiltersBtn.addEventListener('click', () => {
                specialtyFilter.value = ""; statusFilter.value = ""; applyFilters();
            });

            dateFilter.value = getTodayDateString();
            populateSpecialties();
            fetchData(getTodayDateString());
            setupRealtime(); // Start listening for live changes
        }

        async function start() {
            try {
                const response = await fetch('/.netlify/functions/getSupabaseConfig');
                const config = await response.json();
                supabaseClient = supabase.createClient(config.url, config.anonKey);
                initDashboard();
            } catch (error) {
                loadingDiv.classList.add('hidden');
                errorMessageSpan.textContent = "Could not connect to clinical database.";
                errorDiv.classList.remove('hidden');
            }
        }
        
        document.addEventListener('DOMContentLoaded', start);
    </script>
</body>
</html>